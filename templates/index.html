<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remik</title>
    <style>
        .card {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: grab;
        }
        .card.dragging {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <h1>Witaj w grze Remik!</h1>
    <button onclick="startGame()">Rozpocznij grę</button>
    <div id="gameOutput" style="display: none;"></div>
    <div id="playerActions" style="display: none;">
        <h2>Akcje gracza</h2>
        <p>Aktualny gracz: <span id="currentPlayer"></span></p>
        <button id="drawCardButton" onclick="drawCard()">Dobierz kartę</button>
        <select id="discardSelect" disabled></select>
        <button id="discardCardButton" onclick="discardCard()" disabled>Wyrzuć kartę</button>
    </div>
    <div>
        <h3>Stos kart wyrzuconych:</h3>
        <p>Ostatnia karta: <span id="lastDiscardedCard">Brak</span></p>
    </div>
    <div>
        <h3>Punkty:</h3>
        <p>Gracz 1: <span id="pointsPlayer1">0</span></p>
        <p>Gracz 2: <span id="pointsPlayer2">0</span></p>
    </div>
    <p id="errorMessage" style="color: red;"></p>

    <script>
        let rekaGracza1 = [];
        let rekaGracza2 = [];
        let aktualnyGracz = 1;

        function startGame() {
            fetch("/start_game")
                .then(response => response.json())
                .then(data => {
                    rekaGracza1 = data.reka_gracza_1;
                    rekaGracza2 = data.reka_gracza_2;
                    aktualnyGracz = data.aktualny_gracz;

                    document.getElementById("gameOutput").style.display = "block";
                    document.getElementById("gameOutput").innerHTML = `
                        <h2>Karty Gracza 1</h2>
                        <div id="player1Cards">${renderCards(rekaGracza1, "player1")}</div>
                        <h2>Karty Gracza 2</h2>
                        <div id="player2Cards">${renderCards(rekaGracza2, "player2")}</div>
                    `;
                    document.getElementById("lastDiscardedCard").textContent = data.stos || "Brak";
                    document.getElementById("playerActions").style.display = "block";
                    document.getElementById("currentPlayer").textContent = aktualnyGracz;
                    document.getElementById("pointsPlayer1").textContent = data.punkty_gracza_1;
                    document.getElementById("pointsPlayer2").textContent = data.punkty_gracza_2;
                    enableDrawCard();
                });
        }

        function renderCards(cards, playerId) {
            return cards
                .map(
                    (card, index) =>
                        `<div class="card" draggable="true" ondragstart="startDrag(event, '${playerId}', ${index})" ondragover="allowDrop(event)" ondrop="dropCard(event, '${playerId}', ${index})">${card}</div>`
                )
                .join("");
        }

        function startDrag(event, playerId, index) {
            event.dataTransfer.setData("cardIndex", index);
            event.dataTransfer.setData("playerId", playerId);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropCard(event, playerId, dropIndex) {
            event.preventDefault();
            const cardIndex = event.dataTransfer.getData("cardIndex");

            const cards = playerId === "player1" ? rekaGracza1 : rekaGracza2;
            const draggedCard = cards.splice(cardIndex, 1)[0];

            cards.splice(dropIndex, 0, draggedCard);

            updateUI();
        }

        function drawCard() {
            fetch("/draw_card", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    const dobieranaKarta = data.dobrana_karta;
                    if (aktualnyGracz === 1) {
                        rekaGracza1.push(dobieranaKarta);
                    } else {
                        rekaGracza2.push(dobieranaKarta);
                    }
                    updateUI();
                    enableDiscardCard();
                })
                .catch(err => showError(err));
        }

        function discardCard() {
            const selectedCardIndex = document.getElementById("discardSelect").value;
            fetch("/discard_card", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ karta_index: parseInt(selectedCardIndex) })
            })
                .then(response => response.json())
                .then(data => {
                    if (aktualnyGracz === 1) {
                        rekaGracza1.splice(selectedCardIndex, 1);
                    } else {
                        rekaGracza2.splice(selectedCardIndex, 1);
                    }
                    aktualnyGracz = data.aktualny_gracz;
                    document.getElementById("pointsPlayer1").textContent = data.punkty_gracza_1;
                    document.getElementById("pointsPlayer2").textContent = data.punkty_gracza_2;
                    document.getElementById("lastDiscardedCard").textContent = data.stos;
                    updateUI();
                    enableDrawCard();
                })
                .catch(err => showError(err));
        }

        function updateUI() {
            document.getElementById("player1Cards").innerHTML = renderCards(rekaGracza1, "player1");
            document.getElementById("player2Cards").innerHTML = renderCards(rekaGracza2, "player2");
            document.getElementById("currentPlayer").textContent = aktualnyGracz;
            updateDiscardSelect();
        }

        function enableDrawCard() {
            document.getElementById("drawCardButton").disabled = false;
            document.getElementById("discardSelect").disabled = true;
            document.getElementById("discardCardButton").disabled = true;
        }

        function enableDiscardCard() {
            document.getElementById("drawCardButton").disabled = true;
            document.getElementById("discardSelect").disabled = false;
            document.getElementById("discardCardButton").disabled = false;
        }

        function updateDiscardSelect() {
            const select = document.getElementById("discardSelect");
            select.innerHTML = "";
            const karty = aktualnyGracz === 1 ? rekaGracza1 : rekaGracza2;
            karty.forEach((karta, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = karta;
                select.appendChild(option);
            });
        }

        function showError(error) {
            document.getElementById("errorMessage").textContent = error.message || "Wystąpił błąd!";
        }
    </script>
</body>
</html>
